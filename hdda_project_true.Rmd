---
title: "Hdda2"
output: html_document
---

```{r setup, include=FALSE}
#library("rbiom")
library("biomformat")
library("phyloseq")
library("microbiome")
library("vegan")
library("gplots")
```

```{r}
biom <- read_biom("221_otu_table.biom")
summary(biom)
show(biom)
```


```{r}
fecal_samples = as(biom_data(biom), "matrix")
## taxonomic rank: 
# species -genus -family-class- phylum 
bacteria_taxa = observation_metadata(biom)

bacteria_taxa$taxonomy2 <- gsub("\\[|\\]", "", bacteria_taxa$taxonomy2)
bacteria_taxa$taxonomy3 <- gsub("\\[|\\]", "", bacteria_taxa$taxonomy3)
bacteria_taxa$taxonomy4 <- gsub("\\[|\\]", "", bacteria_taxa$taxonomy4)
bacteria_taxa$taxonomy5 <- gsub("\\[|\\]", "", bacteria_taxa$taxonomy5)
bacteria_taxa$taxonomy6 <- gsub("\\[|\\]", "", bacteria_taxa$taxonomy6)
```


```{r}
tax2 <- bacteria_taxa[,c("taxonomy1","taxonomy2")]
tax2["id"] <- rownames(tax2)
tax2["merge"] <- tidyr::unite(tax2[,-ncol(tax2)],"merge_type",sep = ",")

tax3 <- bacteria_taxa[,c("taxonomy1","taxonomy2", "taxonomy3")]
tax3["id"] <- rownames(tax3)
tax3["merge"] <- tidyr::unite(tax3[,-ncol(tax3)],"merge_type",sep = ",")

tax4 <- subset(bacteria_taxa[,c(1:4)], taxonomy4 != "o__")
tax4["id"] <- rownames(tax4)
tax4["merge"] <- tidyr::unite(tax4[,-ncol(tax4)],"merge_type",sep = ",")

tax5 <- subset(bacteria_taxa[,c(1:5)], taxonomy5 != "f__")
tax5["id"] <- rownames(tax5)
tax5["merge"] <- tidyr::unite(tax5[,-ncol(tax5)],"merge_type",sep = ",")

tax6 <- subset(bacteria_taxa[,c(1:6)], taxonomy6 != "g__")
tax6["id"] <- rownames(tax6)
tax6["merge"] <- tidyr::unite(tax6[,-ncol(tax6)],"merge_type",sep = ",")
```

```{r}
tax2[,c("taxonomy1","taxonomy2")] <- list(NULL)
tax3[,c("taxonomy1","taxonomy2","taxonomy3")] <- list(NULL)
tax4[,c("taxonomy1","taxonomy2","taxonomy3","taxonomy4")] <- list(NULL)
tax5[,c("taxonomy1","taxonomy2","taxonomy3","taxonomy4","taxonomy5")] <- list(NULL)
tax6[,c("taxonomy1","taxonomy2","taxonomy3","taxonomy4","taxonomy5","taxonomy6")] <- list(NULL)
```


```{r}
df_fecal <- as.data.frame(fecal_samples)
df_fecal$id <- rownames(df_fecal)
```


```{r}
library(dplyr)
prepare_data <- function(tax2){
  fec_tax2 <- as.data.frame(merge(df_fecal,tax2,by="id", sort = F))
  fec_tax2$id <- NULL
  fec_tax2 <- fec_tax2 %>% group_by(merge) %>% summarize_all(sum) 
  fec_tax2 <- as.data.frame(t(fec_tax2))
  colnames(fec_tax2) <- as.character(unlist(fec_tax2[1,]))
  fec_tax2 <- fec_tax2[-1,]
  return(fec_tax2)
}
```

```{r}
final_tax2 <- as.data.frame(prepare_data(tax2))
final_tax3 <- as.data.frame(prepare_data(tax3))
final_tax4 <- as.data.frame(prepare_data(tax4))
final_tax5 <- as.data.frame(prepare_data(tax5))
final_tax6 <- as.data.frame(prepare_data(tax6))
final <- cbind(final_tax2, final_tax3, final_tax4, final_tax5, final_tax6)
as.data.frame(t(final))
```


```{r}
final_tax6_ab <- as.data.frame(t(final_tax6))
final_tax6_ab <- as.data.frame(lapply(final_tax6_ab, as.numeric))
final_tax6_ab <- as.data.frame(apply(final_tax6_ab,2, function(x){x/sum(x)}))
sum(final_tax6_ab[,1])
```

### CLUSTERING: 
```{r}
OTU <- otu_table(fecal_samples, taxa_are_rows = TRUE)
TAX <- tax_table(as.matrix(bacteria_taxa))
physeq <- phyloseq(OTU, TAX)
```

```{r}
physeq2 <- microbiome::aggregate_taxa(physeq, level = "taxonomy6")
```

```{r}
#df_fecal <- as.data.frame(lapply(df_fecal, as.numeric))
ph <- as.data.frame(otu_table(physeq2))
#dist_jsd <- philentropy::JSD(t(ph))

dist_jsd <- phyloseq::distance(physeq2, method = "jsd")


for (i in 2:20){
  clu <- cluster::pam(dist_jsd,i,diss = T, metric = "euclidean")
  print(clu$silinfo$avg.width)
}

heatmap(as.matrix(dist_jsd))

data_pca = as.data.frame(t(ph))
```


```{r}
nclusters=NULL
for (k in 2:20) { 
			clu <- cluster::pam(dist_jsd,k,diss = T, metric = "manhattan")
			nclusters[k-1]= clu$silinfo$avg.width
	}
plot(nclusters, type="h", xlab="k clusters", ylab="Average Silhouette width", main = "PAM clustering assessment")
```


```{r}
library("corrplot")
clu <- cluster::pam(dist_jsd,2,diss = T, metric = "euclidean") #get cluster 

mds <- cmdscale(dist_jsd,eig=TRUE, k=2) # k is the number of dim
variance_explained_mds = mds$GOF # cumulative percentage of variance explained by first 2 dimensions
x <- mds$points[,1]
y <- mds$points[,2]
plot (x,y,col=cluster_p, ylim = c(-0.8,0.8))

mds # view results

# plot solution
clu$medoids
medoid_cl1 = mds$points[rownames(mds$points) == clu$medoids[1],]
medoid_cl2 = mds$points[rownames(mds$points) == clu$medoids[2],]

data_mds = as.data.frame(mds$points)
colnames(data_mds) = c("x","y")

plot(x, y, main = "Multi Dimensional Scaling plot",col=cluster_p,pch=1)
points(medoid_cl1,pch=19)
points(medoid_cl2,pch=19)
```

```{r}
# differenze tra i cluster
data_pca$cluster = clu$clustering
cluster1 = data_pca[data_pca$cluster == 1,]
cluster2 = data_pca[data_pca$cluster == 2,]

cluster1_ab <- as.data.frame(t(apply(cluster1,1, function(x){x/sum(x)})))
cluster2_ab = as.data.frame(t(apply(cluster2,1, function(x){x/sum(x)})))

# si selezionano prevotella e bacteroides nei due cluster (da rivedere la scelta dei generi)
prevotella_cl1 = cluster1_ab$k__Bacteria_p__Bacteroidetes_c__Bacteroidia_o__Bacteroidales_f__Prevotellaceae_g__Prevotella
prevotella_cl2 = cluster2_ab$k__Bacteria_p__Bacteroidetes_c__Bacteroidia_o__Bacteroidales_f__Prevotellaceae_g__Prevotella
bacteroides_cl1 = cluster1_ab$g__Bacteroides
bacteroides_cl2 = cluster2_ab$g__Bacteroides

# boxplot sull'abundance di Bacteroides
boxplot(bacteroides_cl1,bacteroides_cl2, main= "Abundance Bacteroides in two clusters")

# Boxplot sull'abundance di Prevotella
boxplot(prevotella_cl1,prevotella_cl2, main = "Abundance Prevotella in two clusters")
```
#### Discretizzazione variabili dei nutrienti: 
```{r}
map_nutriens <- read.csv("46764_mapping_file.txt", sep = "\t")
numeric_cols <- unlist(lapply(map_nutriens, is.numeric))  

nut = map_nutriens[ , numeric_cols]

nut[,c("lib_reads_seqd","run_date","qiita_prep_id","age","anonymized_name","data_gen_ncc_database_ave",
                     "data_ncc_database_version","data_software_version_ave","day_of_intake","dri_life_stage_rda_cat",
                     "elevation","energy_kcal_ave","energy_kj_ave","host_subject_id","host_taxid","intake_amount",
                     "intake_reliability","latitude","longitude","perc_cal_from_protein_ave","perc_cal_from_pufa_ave",
                     "perc_cal_from_sfa_ave","polyunsatsat_fat_ratio_ave","qiita_study_id","taxon_id","visit_number")] <- list(NULL)

nutriens = cbind(map_nutriens$X.SampleID,nut)
names(nutriens)[1] = "id"
nutriens = nutriens[vapply(nutriens, function(x) length(unique(x)) > 1, logical(1L))]
to_levels <- gtools::quantcut(nutriens$aspartic_acid_g_ave,3,labels = c("low", "medium","high"))

library(gtools)
                   
to_quantile <- function(x){
    to_cut <- quantcut(x,3,labels = c("low", "medium","high"))
    try(to_cut <- quantcut(x,2,labels = c("very_low", "medium")), silent = TRUE)
    

  return (to_cut)
}    
#(quantile(x)[[1]][1] == 0) & (quantile(x)[[2]][1] == 0) & (quantile(x)[[3]][1] == 0) &
myFunc <- function(x)
{
  if (quantile(x)[[4]][1] == 0){
    to_cut = ifelse(x == 0, "assente", "presente")
  }
  else if (quantile(x)[[3]][1] != 0){
    to_cut = ifelse(x ==0, "assente", quantcut(x[x!=0],3, labels = c("low","medium","high")))
  }
  else {
    to_cut = ifelse(x == 0, "assente","presente")
  }
  return (to_cut)
}


nutriens2 <- nutriens
#nutriens2 <- nutriens2[,-c(51,52)]
#nutriens2<- nutriens2[,-116] 

for(i in 2:ncol(nutriens2)){
  app <- myFunc(nutriens2[,i])                                 
  nutriens2[,i] <- app
}

nutriens2[nutriens2 == 3] <- "high"
nutriens2[nutriens2 == 2] <- "medium"
nutriens2[nutriens2 == 1] <- "low"

``` 


```{r}
lista <- c()
for (i in 1:ncol(nutriens2)){
  permanova <- vegan::adonis(distanza ~ nutriens2[,i],data = perm_nutriens, permutations=1000, method = "bray")
  if (unlist(permanova)$`aov.tab.Pr(>F)1` >= 0){
    lista = append(lista, unlist(permanova)$`aov.tab.Pr(>F)1`)
  }
}
```


```{r}
# merge nutriens dataset with data_pca dataset

standardize = function(col){
  col <- (col - mean(col)) / sd(col)
  return (col)
}
standardized_nutriens = as.data.frame(apply(nutriens[,-1],2,standardize))
standardized_nutriens$id = nutriens[,1]

data_pca$id = rownames(data_pca)
subject_clusters = data_pca[,c("id","cluster")]

nutriens_with_clusters = merge(subject_clusters,standardized_nutriens,by="id")
nutriens_cl1 = nutriens_with_clusters[nutriens_with_clusters$cluster==1,]
nutriens_cl2 = nutriens_with_clusters[nutriens_with_clusters$cluster==2,]

# verify nutrients - enterotype association

strength_nutrients_enterotype1_association = as.matrix(colMeans(nutriens_cl1[,-1]))
strength_nutrients_enterotype2_association = as.matrix(colMeans(nutriens_cl2[,-1]))
associations =cbind(strength_nutrients_enterotype1_association,strength_nutrients_enterotype2_association)

heatmap(associations[2:100,])
```



```{r}
library("FactoMineR")
res.pca <- PCA(ph, graph = T, ncp = 2, scale.unit = T)

fviz_eig(res.pca, addlabels = TRUE, ylim = c(0, 80))
fviz_pca_ind(obs.pca, col.ind = cluster_p, 
             repel = TRUE # Avoid text overlapping (slow if many points)
             )

pam.clustering=function(x,k) { # x is a distance matrix and k the number of clusters
                         require(cluster)
                         cluster = as.vector(pam(as.dist(x), k, diss=TRUE)$clustering)
                         return(cluster)
                        }
cluster_p = pam.clustering(dist_jsd, k=2)

obs.pca=ade4::dudi.pca(as.data.frame(ph), scannf=F, nf = 2)
obs.bet=ade4::bca(obs.pca, fac=as.factor(cluster_p), scannf=T) 
ade4::s.class(obs.bet$ls, fac=as.factor(cluster_p), grid=T)
```





```{r}

```


```{r}

```


```{r}

```


```{r}

```


```{r}
```

